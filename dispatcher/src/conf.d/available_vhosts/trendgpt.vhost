#
# This is the default publish virtualhost definition for Apache.
#
# DO NOT EDIT this file, your changes will have no impact on your deployment.
#
# Instead create a copy in the folder conf.d/available_vhosts and edit the copy.
# Finally, change to the directory conf.d/enabled_vhosts, remove the symbolic
# link for default.vhost and create a symbolic link to your copy.
#

# Include customer defined variables
Include conf.d/variables/custom.vars

<VirtualHost *:80>
    ## Server name
    <IfDefine ENVIRONMENT_LOCAL>
        ServerName ${LOCAL_TRENDGPT_FQDN}
    </IfDefine>
    <IfDefine ENVIRONMENT_DEV>
        ServerName ${DEV_TRENDGPT_FQDN}
    </IfDefine>
    <IfDefine ENVIRONMENT_STAGE>
        ServerName ${STAGE_TRENDGPT_FQDN}
    </IfDefine>
    <IfDefine ENVIRONMENT_PROD>
        ServerName ${PROD_TRENDGPT_FQDN}
    </IfDefine>

    ## Server aliases
    <IfDefine ENVIRONMENT_LOCAL>
        ServerAlias ${LOCAL_TRENDGPT_FQDN_DIRECT}
    </IfDefine>
    <IfDefine ENVIRONMENT_DEV>
        ServerAlias ${DEV_TRENDGPT_FQDN_PREVIEW}
    </IfDefine>
    <IfDefine ENVIRONMENT_STAGE>
        ServerAlias ${STAGE_TRENDGPT_FQDN_PREVIEW}
    </IfDefine>
    <IfDefine ENVIRONMENT_PROD>
         ServerAlias ${PROD_TRENDGPT_FQDN_WWW}
         ServerAlias ${PROD_TRENDGPT_FQDN_DIRECT}
         ServerAlias ${PROD_TRENDGPT_FQDN_PREVIEW}
    </IfDefine>
	# Put names of which domains are used for your published site/content here
    ServerAlias "127.0.0.1" "localhost" "*.local" "publish-*" "preview-*" "*.adobeaemcloud.com" "*.adobeaemcloud.net"

	# Use a document root that matches the one in conf.dispatcher.d/default.farm
	DocumentRoot "${DOCROOT}"
	# URI dereferencing algorithm is applied at Sling's level, do not decode parameters here
	AllowEncodedSlashes NoDecode
	# Add header breadcrumbs for help in troubleshooting
	<IfModule mod_headers.c>
		Header add X-Vhost "trendgpt"
	</IfModule>
	<Directory "${DOCROOT}">
		<IfModule disp_apache2.c>
			# Some items cache with the wrong mime type
			# Use this option to use the name to auto-detect mime types when cached improperly
			ModMimeUsePathInfo On
			# Use this option to avoid cache poisioning
			# Sling will return /content/image.jpg as well as /content/image.jpg/ but apache can't search /content/image.jpg/ as a file
			# Apache will treat that like a directory.  This assures the last slash is never stored in cache
			DirectorySlash Off
			# Enable the dispatcher file handler for apache to fetch files from AEM
			SetHandler dispatcher-handler
		</IfModule>
		Options FollowSymLinks
		AllowOverride None
		Require all granted
		# Insert filter
		SetOutputFilter DEFLATE
		# Don't compress images
		SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary
		# Prevent clickjacking
		Header always append X-Frame-Options SAMEORIGIN
	</Directory>
	<IfModule disp_apache2.c>
		# Enabled to allow rewrites to take affect and not be ignored by the dispatcher module
		DispatcherUseProcessedURL	On
		# Default setting to allow all errors to come from the aem instance
		DispatcherPassError		1
	</IfModule>
	<IfModule mod_rewrite.c>
		RewriteEngine	on
		Include conf.d/rewrites/rewrite.rules

		# Rewrite index page internally, pass through (PT)
		RewriteRule "^(/?)$" "/index.html" [PT]

	</IfModule>

	# Open robots.txt from dispatcher in browser without direct download
	<LocationMatch "/content/dam/${CONTENT_FOLDER_NAME}/site-admin/robots.txt$">
		Header set Content-Disposition inline
	</LocationMatch>

  # Error handling
  ErrorDocument 403 ${403_PAGE}
  ErrorDocument 404 ${404_PAGE}
  ErrorDocument 500 ${500_PAGE}
  ErrorDocument 502 ${500_PAGE}
  ErrorDocument 503 ${500_PAGE}
  ErrorDocument 504 ${500_PAGE}

  ## Default Fastly Cache Settings for AEM
  # Theme Sources via Clientlib: cache mutable resources for max 1 week on CDN and background refresh to avoid MISS
  <LocationMatch "^/etc\.clientlibs/.*\.(?i:json|png|gif|webp|jpe?g|svg)$">
      Header set Cache-Control "max-age=604800,stale-while-revalidate=604800,stale-if-error=604800,public" "expr=%{REQUEST_STATUS} < 400"
      Header set Age 0
  </LocationMatch>
  # Theme Sources via Clientlib: long-term caching (1 year) for immutable URLs, background refresh to avoid MISS
  <LocationMatch "^/etc\.clientlibs/.*\.(?i:js|css|ttf|woff2)$">
      Header set Cache-Control "max-age=31104000,stale-while-revalidate=604800,stale-if-error=604800,public,immutable" "expr=%{REQUEST_STATUS} < 400"
      Header set Age 0
  </LocationMatch>
  # HTML pages: Cache for 5min with background refresh 1h on browser and 1 week on CDN to avoid MISS, also incl. requests with query parameter
  # Cache-Control headers will always be added so it is important to ensure that matching html pages under /content/ are intended to be public
  <LocationMatch "^/content/.*\.html$">
      Header unset Cache-Control
      Header always set Cache-Control "max-age=300,stale-while-revalidate=3600" "expr=%{REQUEST_STATUS} < 400"
      Header always set Surrogate-Control "stale-while-revalidate=604800,stale-if-error=604800" "expr=%{REQUEST_STATUS} < 400"
      Header set Age 0
  </LocationMatch>
  # Content Services/Sling Model Exporter: Cache for 5min with background refresh 1h on browser and 1 week on CDN to avoid MISS
  <LocationMatch "^/content/.*\.model\.json$">
      Header set Cache-Control "max-age=300,stale-while-revalidate=3600" "expr=%{REQUEST_STATUS} < 400"
      Header set Surrogate-Control "stale-while-revalidate=604800,stale-if-error=604800" "expr=%{REQUEST_STATUS} < 400"
      Header set Age 0
  </LocationMatch>
  # Core Component Search Component: Cache for 5min with background refresh 1h on browser and 1 week on CDN to avoid MISS, also incl. requests with query parameter
  <LocationMatch "^/content/.*\.searchresults\.json.*">
      Header always set Cache-Control "max-age=300,stale-while-revalidate=3600" "expr=%{REQUEST_STATUS} < 400"
      Header always set Surrogate-Control "stale-while-revalidate=604800,stale-if-error=604800" "expr=%{REQUEST_STATUS} < 400"
      Header set Age 0
  </LocationMatch>
  # Core Component Image Component: long-term caching (1 year) for immutable URLs, background refresh to avoid MISS
  <LocationMatch "^/content/.*\.coreimg.*\.(?i:jpe?g|png|gif|svg)$">
      Header set Cache-Control "max-age=31104000,stale-while-revalidate=604800,stale-if-error=604800,public,immutable" "expr=%{REQUEST_STATUS} < 400"
      Header set Age 0
  </LocationMatch>
  # Core Component Image Component (WebP enabled): long-term caching (1 year) for immutable URLs, background refresh to avoid MISS
  <LocationMatch "^/adobe/dynamicmedia/deliver.*\.(?i:jpe?g|png|gif|svg)$">
      Header set Cache-Control "max-age=31104000,stale-while-revalidate=604800,stale-if-error=604800,public,immutable" "expr=%{REQUEST_STATUS} < 400"
      Header set Age 0
  </LocationMatch>
  # Images/Video from DAM: cache mutable resources for max 1 week on CDN and background refresh to avoid MISS
  <LocationMatch "^/content/dam/.*\.(?i:jpe?g|gif|js|mov|mp4|png|svg|txt|zip|ico|webp|pdf)$">
      Header set Cache-Control "max-age=604800,stale-while-revalidate=604800,stale-if-error=604800" "expr=%{REQUEST_STATUS} < 400"
      Header set Age 0
  </LocationMatch>
  # ContextHub
  <LocationMatch "^/etc/cloudsettings.kernel.js.*">
      Header always set Cache-Control "max-age=300,stale-while-revalidate=604800,stale-if-error=604800" "expr=%{REQUEST_STATUS} < 400"
      Header set Age 0
  </LocationMatch>
  <LocationMatch "^/conf/.*/settings/wcm/segments.seg.js$">
      Header set Cache-Control "max-age=300,stale-while-revalidate=604800,stale-if-error=604800" "expr=%{REQUEST_STATUS} < 400"
      Header set Age 0
  </LocationMatch>
  <LocationMatch "^/content/.*/_jcr_content/contexthub.pagedata.json$">
      Header set Cache-Control "max-age=300,stale-while-revalidate=604800,stale-if-error=604800" "expr=%{REQUEST_STATUS} < 400"
      Header set Age 0
  </LocationMatch>
</VirtualHost>
